{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Checkout</h1>

    <!-- Display Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Services Summary -->
    <ul class="list-group mb-4">
        {% for service in services %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ service.label or service.name }}
                <span>{{ service.price | currency }}</span>
            </li>
        {% endfor %}
    </ul>
    <h4 class="text-end mb-4">Total: {{ final_price | currency }}</h4>
    
    <!-- Invoice Summary with Fee Breakdown -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Invoice Summary</h4>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-sm-6">Services Total:</div>
                <div class="col-sm-6 text-right">{{ services_total | currency }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-6">Licensing & Insurance Fee:</div>
                <div class="col-sm-6 text-right">{{ fee | currency }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-sm-6">Travel Fee:</div>
                <div class="col-sm-6 text-right">{{ travel_fee | currency }}</div>
            </div>
            <hr>
            <div class="row">
                <div class="col-sm-6"><strong>Final Total:</strong></div>
                <div class="col-sm-6 text-right"><strong>{{ final_price | currency }}</strong></div>
            </div>
        </div>
    </div>

    <!-- Checkout Form -->
    <form id="checkout-form" method="post" action="{{ url_for('customer.checkout') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Service Date Selection -->
        <div class="mb-3">
            <label for="service_date" class="form-label">Select Service Date:</label>
            <input type="date" id="service_date" name="service_date" class="form-control" required value="{{ default_service_date }}">
        </div>

        <!-- Service Time Selection -->
        <div class="mb-3">
            <label for="service_time" class="form-label">Select Service Time:</label>
            <select id="service_time" name="service_time" class="form-select" required>
                {% for hour in range(6, 17) %}
                    {% set hour12 = hour % 12 %}
                    {% set period = 'AM' if hour < 12 else 'PM' %}
                    <option value="{{ '%02d:00' % hour }}">{{ '%02d:00 %s' % (hour12 if hour12 != 0 else 12, period) }}</option>
                    {% if hour != 16 %}
                        <option value="{{ '%02d:30' % hour }}">{{ '%02d:30 %s' % (hour12 if hour12 != 0 else 12, period) }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <small class="form-text text-muted">Available times: 6:00 AM to 4:30 PM</small>
        </div>

        <!-- Payment Option Toggle -->
        <div class="mb-3">
            <label class="form-label">Select Payment Option:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_time" id="pay_now" value="now" required>
                <label class="form-check-label" for="pay_now">Pay Now</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_time" id="pay_after" value="after" required>
                <label class="form-check-label" for="pay_after">Pay After Completion</label>
            </div>
        </div>

        <!-- Stripe Card Payment Section (displayed only if "Pay Now" is selected) -->
        <div class="mb-3" id="stripe-card-section" style="display: none;">
            <label for="card-element" class="form-label">Credit or Debit Card</label>
            <div id="card-element" class="form-control"></div>
            <div id="card-errors" role="alert" class="text-danger mt-2"></div>
        </div>
        
        <button type="submit" class="btn btn-primary">Place Order</button>
    </form>
</div>

<!-- Include Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stripePublishableKey = "{{ stripe_publishable_key }}";
        const stripe = Stripe(stripePublishableKey);
        const elements = stripe.elements();

        const style = {
            base: {
                fontSize: '16px',
                color: '#32325d',
                '::placeholder': { color: '#aab7c4' }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
            }
        };

        const card = elements.create('card', { style: style });
        card.mount('#card-element');

        card.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            displayError.textContent = event.error ? event.error.message : '';
        });

        // Toggle the display of the Stripe card payment section based on the payment option selected
        const payNowRadio = document.getElementById('pay_now');
        const payAfterRadio = document.getElementById('pay_after');
        const stripeCardSection = document.getElementById('stripe-card-section');

        function toggleStripeSection() {
            stripeCardSection.style.display = payNowRadio.checked ? 'block' : 'none';
        }
        payNowRadio.addEventListener('change', toggleStripeSection);
        payAfterRadio.addEventListener('change', toggleStripeSection);

        // Handle form submission when "Pay Now" is selected
        const form = document.getElementById('checkout-form');
        form.addEventListener('submit', function(event) {
            if (payNowRadio.checked) {
                event.preventDefault();
                stripe.createPaymentMethod('card', card).then(function(result) {
                    if (result.error) {
                        document.getElementById('card-errors').textContent = result.error.message;
                    } else {
                        // Append the PaymentMethod ID to the form and submit it
                        const hiddenInput = document.createElement('input');
                        hiddenInput.setAttribute('type', 'hidden');
                        hiddenInput.setAttribute('name', 'payment_method_id');
                        hiddenInput.setAttribute('value', result.paymentMethod.id);
                        form.appendChild(hiddenInput);
                        form.submit();
                    }
                });
            }
        });
    });
</script>
{% endblock %}
