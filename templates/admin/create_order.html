{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

<form method="POST" action="{{ url_for('admin.create_order_page') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Customer -->
    <h3>Customer</h3>
    <div class="mb-3">
        <label class="form-label">Customer</label>
        <select class="form-select" id="customer_id" name="customer_id" required>
            <option value="">-- Select customer --</option>
            {% for customer in customers %}
                <option
                    value="{{ customer._id }}"
                    data-vehicles='{{ customer.vehicles | tojson | safe }}'>
                    {{ customer.full_name }}
                    {% if customer.email %} — {{ customer.email }}{% endif %}
                    {% if customer.phone %} — {{ customer.phone }}{% endif %}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Vehicle -->
    <div class="mb-3">
        <label class="form-label">Vehicle</label>
        <select id="vehicle_select" name="vehicle_id" class="form-select" required>
            <option value="">-- Select vehicle --</option>
        </select>
    </div>

    <!-- Services -->
    <div class="mb-3">
        <label>Services</label>
        <div id="services_container">
            {% for service in services %}
                <div>
                    <input
                        type="checkbox"
                        class="service_checkbox"
                        data-key="{{ service.key }}"
                        data-prices='{{ service.price_by_vehicle_size | tojson | safe }}'
                    >
                    {{ service.label }} ({{ service.category }})
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Hidden computed values -->
    <input type="hidden" name="services" id="services_input">
    <input type="hidden" name="total_cost" id="total_cost_input">
    <input type="hidden" name="estimated_minutes" id="total_time_input">

    <!-- Summary -->
    <div class="mb-3">
        <p>Total Cost: $<span id="total_cost">0.00</span></p>
        <p>Estimated Time: <span id="total_time">0 min</span></p>
    </div>

    <button class="btn btn-primary">Create Order</button>
</form>
</div>




<script>
const customerSelect = document.getElementById("customer_id");
const vehicleSelect = document.getElementById("vehicle_select");

customerSelect.addEventListener("change", () => {
    vehicleSelect.innerHTML = '<option value="">-- Select vehicle --</option>';

    const selectedOption = customerSelect.selectedOptions[0];
    if (!selectedOption) return;

    const vehicles = JSON.parse(selectedOption.dataset.vehicles || "[]");

    vehicles.forEach(vehicle => {
        const opt = document.createElement("option");
        opt.value = vehicle._id;
        opt.textContent = `${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.size})`;
        opt.dataset.size = vehicle.size;
        vehicleSelect.appendChild(opt);
    });
});
</script>





{% endblock %}
